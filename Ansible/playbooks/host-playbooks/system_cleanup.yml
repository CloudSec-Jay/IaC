---
- name: System Cleanup Playbook
  hosts: localhost
  connection: local
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3
    archive_path: '/var/log/archives'
    ansible_bin_path: "{{ ansible_playbook_python | dirname }}"
  tasks:
    - name: Clean DNF cache
      ansible.builtin.dnf:
        autoremove: true

    - name: Remove unused Docker data
      community.docker.docker_prune:
        containers: true
        images: true
        networks: true
        volumes: false

    - name: Ensure archive directory exists
      ansible.builtin.file:
        path: "{{ archive_path }}"
        state: directory
        mode: '0755'

    - name: Find logs older than 30d
      ansible.builtin.find:
        paths: /var/log
        age: 30d
        patterns: "*.log"
      register: found_logs

    - name: Compress and cleanup
      community.general.archive:
        path: "{{ item.path }}"
        dest: "{{ archive_path }}/{{ item.path | basename }}_{{ ansible_date_time.date }}.gz"
        format: gz
        remove: true
        mode: '0640'
      loop: "{{ found_logs.files }}"
      when: found_logs.matched > 0

    - name: Schedule this as a ROOT cron job
      ansible.builtin.cron:
        name: "Weekly Log Archival"
        minute: "0"
        hour: "3"
        weekday: "1"
        user: root
        job: |
          {{ ansible_bin_path }}/ansible-playbook {{ playbook_dir }}/{{ ansible_self_filename | default('system_cleanup.yml') }} \
          >> /var/log/ansible_cleanup.log 2>&1
